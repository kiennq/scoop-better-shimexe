name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            target: x86-windows-msvc
            can_run: true
            optimize: ReleaseSmall
          - arch: x86_64
            target: x86_64-windows-msvc
            optimize: ReleaseSmall
            can_run: true
          - arch: aarch64
            target: aarch64-windows-msvc
            can_run: false
            optimize: ReleaseSmall
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0

      - name: Build (${{ matrix.arch }})
        working-directory: build
        run: zig build -Dtarget=${{ matrix.target }} -Doptimize=${{ matrix.optimize }}

      - name: Verify artifact exists
        run: |
          if (-not (Test-Path build/zig-out/bin/shim.exe)) {
            Write-Error "shim.exe not found"
            exit 1
          }
          Get-Item build/zig-out/bin/shim.exe

      - name: Run tests (${{ matrix.arch }})
        if: matrix.can_run
        run: ./test/run-tests.ps1 -ShimExe build/zig-out/bin/shim.exe
