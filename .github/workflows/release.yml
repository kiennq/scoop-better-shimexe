name: Release

on:
  schedule:
    - cron: "0 0 * * 0" # weekly
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'version'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      should_release: ${{ steps.version.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release
        continue-on-error: true
        id: cur_release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}
          excludes: draft

      - name: Get version
        id: version
        run: |
          base_ver=$(cat version | tr -d '[:space:]')
          sha=${GITHUB_SHA::7}
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            prerelease=true
            version="${base_ver}.${sha}"
          else
            prerelease=false
            version="${base_ver}"
          fi
          cur_ver="${{ steps.cur_release.outputs.release }}"
          if [[ "${{ steps.cur_release.outcome }}" == "failure" ]]; then
            cur_ver="v0"
          fi
          if [[ "v${version}" == "${cur_ver}" ]]; then
            echo "Version ${version} already released, skipping"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "prerelease=${prerelease}" >> $GITHUB_OUTPUT

  build:
    needs: version
    if: needs.version.outputs.should_release == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            target: x86-windows-gnu
            exe_name: shim-ia32.exe
          - arch: arm64
            target: aarch64-windows-gnu
            exe_name: shim-aarch64.exe
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.0

      - name: Build (${{ matrix.arch }})
        working-directory: build
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSmall
          Rename-Item -Path "zig-out/bin/shim.exe" -NewName "${{ matrix.exe_name }}"

      - name: Generate checksums
        working-directory: build/zig-out/bin
        run: |
          $sha256 = (Get-FileHash "${{ matrix.exe_name }}" -Algorithm SHA256).Hash.ToLower()
          "$sha256  ${{ matrix.exe_name }}" | Out-File -Encoding ascii "${{ matrix.exe_name }}.sha256"
          $sha512 = (Get-FileHash "${{ matrix.exe_name }}" -Algorithm SHA512).Hash.ToLower()
          "$sha512  ${{ matrix.exe_name }}" | Out-File -Encoding ascii "${{ matrix.exe_name }}.sha512"

      - name: Create zip
        working-directory: build/zig-out/bin
        run: |
          Compress-Archive -Path "${{ matrix.exe_name }}", "${{ matrix.exe_name }}.sha256", "${{ matrix.exe_name }}.sha512" -DestinationPath "shimexe-${{ matrix.arch }}.zip"

      - name: Publish to release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.version.outputs.version }}
          name: ${{ needs.version.outputs.version }}
          draft: false
          prerelease: ${{ needs.version.outputs.prerelease == 'true' }}
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifacts: build/zig-out/bin/shimexe-${{ matrix.arch }}.zip
          artifactContentType: application/zip
          token: ${{ secrets.GITHUB_TOKEN }}
